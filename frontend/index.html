<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <base href="/">
  <title>Strukturbild Editor</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/cytoscape-context-menus/cytoscape-context-menus.css" />
  <style>
    :root {
      --gap: 0;
      --left-min: 320px;
      --right-min: 320px;
      --divider-w: 6px;
      --left-fr: 1.2;  /* initial left width ratio (persisted to localStorage) */
      --right-fr: 1;   /* initial right width ratio */
      --pane-bg: #fff;
      --border: #e5e5e5;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #fafafa; }

    /* Split layout */
    #app.split {
      position: relative;
      height: 100vh;
      display: grid;
      grid-template-columns: minmax(var(--left-min), 1fr) var(--divider-w) minmax(var(--right-min), 1fr);
      gap: 0;
    }
    /* We will set columns dynamically via JS to reflect saved ratio */
    .split-left, .split-right {
      overflow: hidden;
      background: var(--pane-bg);
      border: 1px solid var(--border);
    }
    .split-left { border-right: none; display: flex; flex-direction: column; }
    .split-right { border-left: none; padding: 12px 16px; overflow: auto; }

    /* Divider */
    #divider {
      cursor: col-resize;
      background: linear-gradient(90deg, transparent 0, rgba(0,0,0,0.08) 50%, transparent 100%);
      width: var(--divider-w);
    }
    #divider::after {
      content: "";
      display: block;
      width: 2px;
      height: 100%;
      margin: 0 auto;
      background: rgba(0,0,0,0.12);
    }

    /* Toolbar + Cytoscape */
    #mini-toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      background: #f7f7f7;
      flex: 0 0 auto;
    }
    #mini-toolbar label { font-size: 12px; color: #444; }
    #mini-toolbar select, #mini-toolbar button {
      font-size: 12px;
      padding: 6px 8px;
    }
    #cy { flex: 1 1 auto; height: auto; }

    /* Hide only the old status dump */
#status { display: none !important; }


    /* Compact styling for restored editor toolbar row */
    #mini-toolbar input[type="text"] {
      font-size: 12px;
      padding: 6px 8px;
      width: 160px;
    }
    #mini-toolbar .spacer { flex: 1 1 auto; }
    #mini-toolbar .hidden { display: none !important; }

    /* Responsive fallback to stacked layout on narrow screens */
    @media (max-width: 900px) {
      #app.split {
        grid-template-columns: 1fr;
        grid-template-rows: 56vh var(--divider-w) 44vh;
      }
      #divider { cursor: row-resize; height: var(--divider-w); width: 100%; }
      #divider::after { width: 100%; height: 2px; }
      .split-left, .split-right { border: 1px solid var(--border); }
      .split-left { border-bottom: none; }
      .split-right { border-top: none; }
    }

    /* --- Split view overrides: show BOTH panes in story mode --- */
    body.story-mode #cy {
      display: block !important;  /* override style.css which hides #cy in story-mode */
    }
    body.story-mode #story-root {
      display: flex !important;   /* keep right pane visible */
    }
  </style>
  <script>
    (function ensureStoryQueryParam() {
      try {
        var loc = window.location || {};
        var path = loc.pathname || "";
        var match = path.match(/\/stories\/([^/]+)/);
        if (!match || !match[1]) return;
        var storyFromPath = decodeURIComponent(match[1]);
        var basePath = path.replace(/\/stories\/[^/]*$/, "/");
        if (!basePath.endsWith("/")) basePath += "/";
        var params = new URLSearchParams(loc.search || "");
        if (params.get("storyId") === storyFromPath) {
          if (path !== basePath) {
            var normalized = `${basePath}${loc.search || ""}${loc.hash || ""}`;
            window.history.replaceState({ storyId: storyFromPath }, "", normalized);
          }
          return;
        }
        params.set("storyId", storyFromPath);
        var nextUrl = `${basePath}?${params.toString()}${loc.hash || ""}`;
        window.history.replaceState({ storyId: storyFromPath }, "", nextUrl);
      } catch (err) {
        // Ignore environments without URLSearchParams/history support
      }
    })();
  </script>
</head>
<body>

  <div id="app" class="split">
    <section id="cy-pane" class="split-left">
      <div id="mini-toolbar" class="toolbar">
        <select id="storySelect" title="Select a story">
          <option value="">Loading storiesâ€¦</option>
        </select>
        <input id="storyIdInput" type="hidden" placeholder="Story ID" title="Story ID">

        <span class="spacer"></span>

        <!-- Keep layoutSelect for script.js compatibility but lock to Grid and hide -->
        <label for="layoutSelect" title="Layout" class="hidden">Layout:</label>
        <select id="layoutSelect" title="Layout" class="hidden">
          <option value="grid" selected>Grid</option>
        </select>

        <button id="centerViewBtn" title="Center View">Center</button>
        <button id="connectBtn" title="Connect Selected">Connect Selected</button>
        <button id="addNodeBtn" title="Add Node">Add Node</button>
        <button id="deleteBtn" title="Delete Selected">Delete Selected</button>
        <button id="saveLayoutBtn" title="Save Layout">Save</button>
      </div>
      <div id="cy"></div>
    </section>
    <div id="divider" role="separator" aria-orientation="vertical" aria-label="Resize panels"></div>
    <section id="story-root" class="split-right"></section>
  </div>

  <script src="https://unpkg.com/cytoscape@3.24.0/dist/cytoscape.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://unpkg.com/cytoscape-context-menus/cytoscape-context-menus.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="config.js"></script>
  <script src="script.js"></script>
  <script>window.__PARA_NODE_MAP__ = window.__PARA_NODE_MAP__ || { /* paragraphId: [nodeIds] */ };</script>
  <script type="text/babel" data-type="module" src="story/index.jsx"></script>
  <script>
    (function splitResize() {
      var root = document.documentElement;
      var app = document.getElementById('app');
      var divider = document.getElementById('divider');
      if (!app || !divider) return;

      function setColsFromRatio(r) {
        // r = 0..1 represents left percentage
        r = Math.max(0.15, Math.min(0.85, r));
        app.style.gridTemplateColumns = `minmax(var(--left-min), ${r}fr) var(--divider-w) minmax(var(--right-min), ${1 - r}fr)`;
      }

      // Load saved ratio
      var saved = localStorage.getItem('split.leftRatio');
      var ratio = saved ? parseFloat(saved) : 0.55;
      if (!isNaN(ratio)) setColsFromRatio(ratio);

      var dragging = false;
      function onMove(e) {
        if (!dragging) return;
        var rect = app.getBoundingClientRect();
        if (window.matchMedia('(max-width: 900px)').matches) {
          // vertical resize
          var y = e.touches ? e.touches[0].clientY : e.clientY;
          var rel = (y - rect.top) / rect.height;
          rel = Math.max(0.2, Math.min(0.8, rel));
          app.style.gridTemplateRows = `minmax(40vh, ${rel*100}vh) var(--divider-w) 1fr`;
        } else {
          // horizontal resize
          var x = e.touches ? e.touches[0].clientX : e.clientX;
          var rel = (x - rect.left) / rect.width;
          rel = Math.max(0.15, Math.min(0.85, rel));
          setColsFromRatio(rel);
          localStorage.setItem('split.leftRatio', String(rel));
        }
        e.preventDefault();
      }
      function onUp() {
        dragging = false;
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        document.removeEventListener('touchmove', onMove);
        document.removeEventListener('touchend', onUp);
      }
      function onDown(e) {
        dragging = true;
        document.addEventListener('mousemove', onMove, { passive: false });
        document.addEventListener('mouseup', onUp);
        document.addEventListener('touchmove', onMove, { passive: false });
        document.addEventListener('touchend', onUp);
        e.preventDefault();
      }
      divider.addEventListener('mousedown', onDown);
      divider.addEventListener('touchstart', onDown, { passive: false });
    })();

    // Ensure Grid layout is selected on load for consistency with previous behavior
    (function ensureDefaultLayout() {
      var sel = document.getElementById('layoutSelect');
      if (sel) {
        sel.value = 'grid';
        var ev = document.createEvent('HTMLEvents');
        ev.initEvent('change', true, false);
        sel.dispatchEvent(ev);
      }
    })();
  </script>
</body>
</html>